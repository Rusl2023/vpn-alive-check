name: Filter Stable VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'  # каждые 9 минут
  workflow_dispatch:

jobs:
  filter-stable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # важно для GH_PAT push

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websocket-client

      - name: Filter stable VLESS servers
        id: filter_stable
        run: |
          python - <<'EOF'
          import os, socket, requests, time
          from concurrent.futures import ThreadPoolExecutor, as_completed
          from websocket import create_connection

          INPUT_FILE = "githubmirror/26_alive.txt"
          OUTPUT_FILE = "githubmirror/26_stable.txt"
          TIMEOUT = 0.8
          MAX_WORKERS = 100
          MAX_PING = 400  # мс

          if not os.path.exists(INPUT_FILE):
              print("Input file does not exist, exiting")
              exit(0)

          with open(INPUT_FILE) as f:
              vless_list = [l.strip() for l in f if l.strip()]

          def check_stable(link):
              try:
                  country = link.split('#')[-1] if '#' in link else 'unknown'
                  hp = link.split('@')[1].split('?')[0]
                  host, port = hp.split(':')
                  port = int(port)

                  # TCP ping
                  start = time.time()
                  sock = socket.create_connection((host, port), timeout=TIMEOUT)
                  sock.close()
                  ping = int((time.time() - start) * 1000)
                  if ping > MAX_PING:
                      return None

                  # WebSocket check
                  try:
                      ws = create_connection(f"ws://{host}:{port}", timeout=TIMEOUT)
                      ws.close()
                  except Exception:
                      return None

                  # HTTP check
                  try:
                      r = requests.get(f"http://{host}:{port}", timeout=TIMEOUT)
                      if r.status_code >= 400:
                          return None
                  except Exception:
                      return None

                  return country, link, ping
              except Exception:
                  return None

          stable_by_country = {}

          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              futures = [exe.submit(check_stable, v) for v in vless_list]
              for f in as_completed(futures):
                  res = f.result()
                  if not res:
                      continue
                  country, link, ping = res
                  old = stable_by_country.get(country)
                  if old is None or ping < old[2]:
                      stable_by_country[country] = (link, country, ping)

          os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
          with open(OUTPUT_FILE, 'w') as f:
              for link, _, _ in stable_by_country.values():
                  f.write(link + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(stable_by_country)}\n")
          EOF

      - name: Commit and push stable servers
        if: steps.filter_stable.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_stable.txt
          git diff --cached --quiet || git commit -m "Update stable VLESS servers"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main

      - name: Create or update stable release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          overwrite: true
