name: Filter Stable VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'  # каждые 9 минут
  workflow_dispatch:        # ручной запуск

jobs:
  filter-stable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false   # чтобы пуш через GH_PAT работал

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install websocket-client requests

      - name: Filter stable VLESS servers
        id: filter_stable
        run: |
          python - <<'EOF'
          import os, socket, time
          from websocket import create_connection

          INPUT_FILE = "githubmirror/26_alive.txt"
          OUTPUT_FILE = "githubmirror/26_stable.txt"
          TIMEOUT = 1.5
          MAX_PING = 400

          alive_by_country = {}

          if not os.path.exists(INPUT_FILE):
              print(f"{INPUT_FILE} not found")
              exit(0)

          with open(INPUT_FILE) as f:
              lines = [l.strip() for l in f if l.strip()]

          print(f"Checking {len(lines)} servers for stability ...")

          for link in lines:
              try:
                  country = link.split('#')[-1] if '#' in link else 'unknown'
                  hp = link.split('@')[1].split('?')[0]
                  host, port = hp.split(':')
                  port = int(port)

                  start = time.time()
                  sock = socket.create_connection((host, port), timeout=TIMEOUT)
                  sock.close()
                  ping = int((time.time() - start) * 1000)

                  if ping > MAX_PING:
                      print(f"[SKIP] {country} ping {ping} > {MAX_PING}")
                      continue

                  # Проверка WebSocket
                  try:
                      ws = create_connection(f"ws://{host}:{port}", timeout=TIMEOUT)
                      ws.close()
                  except Exception:
                      print(f"[SKIP] {country} WebSocket failed")
                      continue

                  old = alive_by_country.get(country)
                  if old is None or ping < old[1]:
                      alive_by_country[country] = (link, ping)
                      print(f"[OK] {country} ping {ping} ms")

              except Exception as e:
                  print(f"[SKIP] {link} error: {e}")
                  continue

          # Сохраняем стабильные сервера
          os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
          with open(OUTPUT_FILE, "w") as f:
              for link, ping in sorted(alive_by_country.values(), key=lambda x: x[1]):
                  f.write(link + "\n")

          print(f"Stable servers saved: {len(alive_by_country)}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(alive_by_country)}\n")
          EOF

      - name: Commit stable servers
        if: steps.filter_stable.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_stable.txt
          git diff --cached --quiet || git commit -m "Update stable VLESS servers"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main

      - name: Create/Update release
        if: steps.filter_stable.outputs.count != '0'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          makeLatest: true
          generateReleaseNotes: false
