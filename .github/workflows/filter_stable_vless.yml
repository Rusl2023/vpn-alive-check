name: Filter Stable VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'
  workflow_dispatch:

jobs:
  filter-stable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # чтобы пуш через GH_PAT работал

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websocket-client

      - name: Filter stable VLESS servers
        id: filter_stable
        run: |
          python - <<'EOF'
          import os, socket, time, requests
          from concurrent.futures import ThreadPoolExecutor, as_completed
          from websocket import create_connection

          INPUT_FILE = "githubmirror/26_alive.txt"
          OUTPUT_FILE = "githubmirror/26_stable.txt"
          TIMEOUT = 1
          MAX_WORKERS = 60
          MAX_PING = 400

          def check_vless(link):
              try:
                  country = link.split('#')[-1] if '#' in link else 'unknown'
                  hp = link.split('@')[1].split('?')[0]
                  host, port = hp.split(':')
                  port = int(port)

                  start = time.time()
                  # TCP check
                  sock = socket.create_connection((host, port), timeout=TIMEOUT)
                  sock.close()
                  tcp_ping = int((time.time() - start) * 1000)
                  if tcp_ping > MAX_PING:
                      return None

                  # WebSocket check (simple connect)
                  try:
                      ws_url = f"ws://{host}:{port}/"
                      ws = create_connection(ws_url, timeout=TIMEOUT)
                      ws.close()
                  except:
                      return None

                  return country, link, tcp_ping
              except:
                  return None

          alive_links = []
          with open(INPUT_FILE, "r") as f:
              alive_links = [l.strip() for l in f if l.strip()]

          stable_by_country = {}
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              futures = [exe.submit(check_vless, l) for l in alive_links]
              for f in as_completed(futures):
                  res = f.result()
                  if not res:
                      continue
                  country, link, ping = res
                  old = stable_by_country.get(country)
                  if old is None or ping < old[2]:
                      stable_by_country[country] = (country, link, ping)
                      print(f"[STABLE] {country} {ping} ms")

          os.makedirs("githubmirror", exist_ok=True)
          with open(OUTPUT_FILE, "w") as f:
              for c, link, ping in stable_by_country.values():
                  f.write(link + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(stable_by_country)}\n")
          EOF

      - name: Commit and push stable servers
        if: steps.filter_stable.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_stable.txt
          git diff --cached --quiet || git commit -m "Update stable VLESS servers"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main

      - name: Create or update stable release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          replacesArtifacts: true
          updateOnlyUnreleased: false
          makeLatest: true
          generateReleaseNotes: false
