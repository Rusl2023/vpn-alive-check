name: Filter Stable VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'  # каждые 9 минут
  workflow_dispatch:

jobs:
  filter-stable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # чтобы пуш и релиз через GH_PAT работал

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websocket-client

      - name: Filter stable VLESS servers
        id: filter_stable
        run: |
          python - <<'EOF'
          import os, requests, socket, time
          from concurrent.futures import ThreadPoolExecutor, as_completed
          from websocket import create_connection

          INPUT_FILE = "githubmirror/26_alive.txt"
          OUTPUT_FILE = "githubmirror/26_stable.txt"
          MAX_PING = 400
          TIMEOUT = 0.8
          MAX_WORKERS = 80

          if not os.path.exists(INPUT_FILE):
              print(f"{INPUT_FILE} not found, exiting")
              exit(0)

          with open(INPUT_FILE, "r") as f:
              vless_list = [l.strip() for l in f if l.strip()]

          alive_by_country = {}

          def check_vless(link):
              try:
                  country = link.split('#')[-1] if '#' in link else 'unknown'
                  hp = link.split('@')[1].split('?')[0]
                  host, port = hp.split(':')
                  port = int(port)

                  start = time.time()
                  # TCP check
                  sock = socket.create_connection((host, port), timeout=TIMEOUT)
                  sock.close()
                  tcp_ping = int((time.time() - start) * 1000)
                  if tcp_ping > MAX_PING:
                      return None

                  # WebSocket check (optional)
                  try:
                      ws = create_connection(f"ws://{host}:{port}", timeout=TIMEOUT)
                      ws.close()
                  except Exception:
                      return None

                  return country, link, tcp_ping
              except Exception:
                  return None

          start_all = time.time()
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              futures = [exe.submit(check_vless, v) for v in vless_list]
              for f in as_completed(futures):
                  res = f.result()
                  if not res:
                      continue
                  country, link, ping = res
                  old = alive_by_country.get(country)
                  if old is None or ping < old[1]:
                      alive_by_country[country] = (link, ping)

          os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
          with open(OUTPUT_FILE, "w") as f:
              for link, ping in sorted(alive_by_country.values(), key=lambda x: x[1]):
                  f.write(link + "\n")

          print(f"Stable servers saved: {len(alive_by_country)}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(alive_by_country)}\n")
          EOF

      - name: Create or update stable release
        if: steps.filter_stable.outputs.count != '0'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          replacesArtifacts: true
          updateOnlyUnreleased: false
          makeLatest: true
          generateReleaseNotes: false
