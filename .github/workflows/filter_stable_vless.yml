name: Filter Stable VLESS Servers

on:
  workflow_dispatch:  # –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  schedule:
    - cron: '*/10 * * * *'  # –∞–≤—Ç–æ-–∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

jobs:
  filter_stable:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          pip install -r source/requirements.txt

      - name: Filter stable servers
        env:
          INPUT_FILE: githubmirror/26_alive.txt
          OUTPUT_FILE: githubmirror/26_stable.txt
          MAX_PING: 600
        run: |
          python - <<'EOF'
import os
import socket
from urllib.parse import urlparse

INPUT_FILE = os.environ["INPUT_FILE"]
OUTPUT_FILE = os.environ["OUTPUT_FILE"]
MAX_PING = int(os.environ["MAX_PING"])

alive_by_country = {}

def check_tcp(host, port, timeout=3):
    try:
        with socket.create_connection((host, port), timeout=timeout):
            return True
    except:
        return False

with open(INPUT_FILE, "r", encoding="utf-8") as f:
    for line in f:
        line = line.strip()
        if not line:
            continue
        try:
            url = urlparse(line)
            host = url.hostname
            port = url.port or 443
            # —á–∏—Ç–∞–µ–º ping –∏–∑ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å "ping XXX"
            if "ping" in line:
                ping_str = line.split("ping")[-1].split()[0]
                ping_val = int(ping_str)
            else:
                ping_val = 9999  # –µ—Å–ª–∏ –Ω–µ—Ç, —Å—á–∏—Ç–∞–µ–º –ø–ª–æ—Ö–∏–º
            # —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ ping
            if ping_val > MAX_PING:
                continue
            # –ø—Ä–æ–≤–µ—Ä–∫–∞ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if not check_tcp(host, port):
                continue
            # –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–∞–Ω—É –∏–∑ —Å—Ç—Ä–æ–∫–∏
            country = "Unknown"
            for part in line.split():
                if part.startswith("üá¶") or part.startswith("üáß") or part.startswith("üá®") or part.startswith("RU") or part.startswith("US") or part.startswith("NL") or part.startswith("FI") or part.startswith("PL") or part.startswith("DE"):
                    country = part
                    break
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª—É—á—à–∏–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω—É
            if country not in alive_by_country or ping_val < alive_by_country[country][1]:
                alive_by_country[country] = (line, ping_val)
        except Exception:
            continue

# —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
    for link, ping in sorted(alive_by_country.values(), key=lambda x: x[1]):
        f.write(link + "\n")

print(f"Stable servers saved: {len(alive_by_country)}")

# –≤—ã–≤–æ–¥ –¥–ª—è GitHub Actions
with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as out:
    out.write(f"count={len(alive_by_country)}\n")
EOF

      - name: Create/Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          makeLatest: true
          generateReleaseNotes: false
          updateOnlyUnreleased: true
