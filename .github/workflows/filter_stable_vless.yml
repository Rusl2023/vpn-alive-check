name: Filter Stable VLESS Servers

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'  # ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 Ð¼Ð¸Ð½ÑƒÑ‚

jobs:
  filter_stable:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements
        run: pip install -r source/requirements.txt

      - name: Filter stable servers
        env:
          INPUT_FILE: githubmirror/26_alive.txt
          OUTPUT_FILE: githubmirror/26_stable.txt
          MAX_PING: 600
        run: |
          import os
          import socket
          from urllib.parse import urlparse

          INPUT_FILE = os.environ["INPUT_FILE"]
          OUTPUT_FILE = os.environ["OUTPUT_FILE"]
          MAX_PING = int(os.environ["MAX_PING"])

          alive_by_country = {}

          def check_tcp(host, port, timeout=3):
              try:
                  with socket.create_connection((host, port), timeout=timeout):
                      return True
              except:
                  return False

          with open(INPUT_FILE, "r", encoding="utf-8") as f:
              for line in f:
                  line = line.strip()
                  if not line:
                      continue
                  try:
                      url = urlparse(line)
                      host = url.hostname
                      port = url.port or 443
                      ping_val = 9999
                      if "ping" in line:
                          ping_str = line.split("ping")[-1].split()[0]
                          ping_val = int(ping_str)
                      if ping_val > MAX_PING:
                          continue
                      if not check_tcp(host, port):
                          continue
                      country = "Unknown"
                      for part in line.split():
                          if part.startswith(("ðŸ‡¦","ðŸ‡§","ðŸ‡¨","RU","US","NL","FI","PL","DE")):
                              country = part
                              break
                      if country not in alive_by_country or ping_val < alive_by_country[country][1]:
                          alive_by_country[country] = (line, ping_val)
                  except:
                      continue

          os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)
          with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
              for link, ping in sorted(alive_by_country.values(), key=lambda x: x[1]):
                  f.write(link + "\n")

          print(f"Stable servers saved: {len(alive_by_country)}")
          with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as out:
              out.write(f"count={len(alive_by_country)}\n")

      - name: Create/Update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          makeLatest: true
          generateReleaseNotes: false
          updateOnlyUnreleased: true
