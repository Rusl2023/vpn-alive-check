name: Filter & Release Stable VLESS Servers

on:
  workflow_dispatch: {}           # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '*/10 * * * *'       # –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

jobs:
  filter-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pysocks

      - name: Download and Filter VLESS Servers
        id: filter_stable
        env:
          MAX_PING: 600
          OUTPUT_FILE: githubmirror/26_stable.txt
        run: |
          python - <<'EOF'
import os, socket, requests
from urllib.parse import urlparse

URL = 'https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt'
TIMEOUT = 1.0

lines = requests.get(URL, timeout=15).text.splitlines()
vless_list = [l.strip() for l in lines if l.strip().startswith("vless://")]

alive_by_country = {}

def check_tcp(host, port, timeout=3):
    try:
        with socket.create_connection((host, port), timeout=timeout):
            return True
    except:
        return False

for line in vless_list:
    try:
        url = urlparse(line)
        host = url.hostname
        port = url.port or 443

        ping_val = 9999
        if "ping" in line:
            ping_str = line.split("ping")[-1].split()[0]
            ping_val = int(ping_str)

        if ping_val > int(os.environ["MAX_PING"]):
            continue
        if not check_tcp(host, port):
            continue

        country = "Unknown"
        for part in line.split():
            if part.startswith(("üá¶","üáß","üá®","RU","US","NL","FI","PL","DE")):
                country = part
                break

        old = alive_by_country.get(country)
        if old is None or ping_val < old[1]:
            alive_by_country[country] = (line, ping_val)
    except:
        continue

os.makedirs(os.path.dirname(os.environ["OUTPUT_FILE"]), exist_ok=True)
with open(os.environ["OUTPUT_FILE"], "w", encoding="utf-8") as f:
    for link, ping in sorted(alive_by_country.values(), key=lambda x: x[1]):
        f.write(link + "\n")

with open(os.environ["GITHUB_OUTPUT"], "a") as out:
    out.write(f"count={len(alive_by_country)}\n")
EOF

      - name: Create/Update GitHub Release
        if: ${{ secrets.GH_PAT != '' }}
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag: stable-vless
          name: Stable VLESS Servers
          artifacts: githubmirror/26_stable.txt
          makeLatest: true
          generateReleaseNotes: false
          updateOnlyUnreleased: true
