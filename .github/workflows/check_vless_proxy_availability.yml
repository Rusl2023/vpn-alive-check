name: Check VLESS proxy availability via Xray

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq unzip python3

      - name: Download Xray (non-interactive)
        run: |
          XRAY_VER=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/download/${XRAY_VER}/Xray-linux-64.zip
          unzip -o xray.zip xray geoip.dat geosite.dat
          chmod +x xray

      - name: Prepare result files
        run: |
          mkdir -p githubmirror
          : > githubmirror/26_proxy_alive.txt
          : > githubmirror/26_proxy_ru_exit.txt
          : > githubmirror/26_proxy_blocked_azure.txt

      - name: Get runner IP
        run: |
          echo "RUNNER_IP=$(curl -s https://api.ipify.org)" >> $GITHUB_ENV

      - name: Check VLESS via SOCKS + GeoIP + HTTP/HTTPS
        run: |
          python3 - <<'EOF'
          import subprocess, time, json, urllib.parse, os, urllib.request

          INPUT = "githubmirror/26_ru_whitelist.txt"
          RUNNER_IP = os.environ["RUNNER_IP"]

          TEST_URLS = [
              "https://api.ipify.org",
              "http://cp.cloudflare.com",
              "https://www.instagram.com/"
          ]

          def exit_ip():
              for url in TEST_URLS:
                  try:
                      ip = subprocess.check_output(
                          ["curl","-s","--max-time","8",
                           "-x","socks5h://127.0.0.1:1080", url],
                          text=True
                      ).strip()
                      if ip:
                          return ip
                  except:
                      continue
              return None

          def get_country(ip):
              try:
                  with urllib.request.urlopen(f"https://ipapi.co/{ip}/country/") as resp:
                      return resp.read().decode().strip()
              except:
                  return "Unknown"

          with open(INPUT) as f:
              links = [l.strip() for l in f if l.strip().startswith("vless://")]

          for link in links:
              print("Checking:", link[:80])

              u = urllib.parse.urlparse(link)
              q = urllib.parse.parse_qs(u.query)

              stream = {"network": q.get("type",["tcp"])[0]}
              sec = q.get("security",["none"])[0]
              sni = q.get("sni",[""])[0]

              if sec == "tls" and sni:
                  stream["security"] = "tls"
                  stream["tlsSettings"] = {"serverName": sni}

              if sec == "reality" and "pbk" in q:
                  stream["security"] = "reality"
                  stream["realitySettings"] = {
                      "serverName": sni,
                      "publicKey": q["pbk"][0],
                      "shortId": q.get("sid",[""])[0]
                  }

              cfg = {
                  "inbounds": [{
                      "port": 1080,
                      "listen": "127.0.0.1",
                      "protocol": "socks",
                      "settings": {"udp": False}
                  }],
                  "outbounds": [{
                      "protocol": "vless",
                      "settings": {
                          "vnext": [{
                              "address": u.hostname,
                              "port": u.port,
                              "users": [{
                                  "id": u.username,
                                  "encryption": "none",
                                  "flow": q.get("flow",[""])[0]
                              }]
                          }]
                      },
                      "streamSettings": stream
                  }]
              }

              with open("cfg.json","w") as cfg_file:
                  cfg_file.write(json.dumps(cfg))

              p = subprocess.Popen(
                  ["./xray","run","-c","cfg.json"],
                  stdout=subprocess.DEVNULL,
                  stderr=subprocess.DEVNULL
              )

              time.sleep(3)
              ip = exit_ip()
              p.terminate()
              time.sleep(1)

              if not ip or ip == RUNNER_IP:
                  print("âš ï¸ Azure / no exit")
                  with open("githubmirror/26_proxy_blocked_azure.txt","a") as f:
                      f.write(link + "\n")
                  continue

              country = get_country(ip)

              if country == "RU":
                  print("ðŸ‡·ðŸ‡º RU exit", ip)
                  with open("githubmirror/26_proxy_ru_exit.txt","a") as f:
                      f.write(link + "\n")
              else:
                  print("âœ… Alive", ip)
                  with open("githubmirror/26_proxy_alive.txt","a") as f:
                      f.write(link + "\n")

          print("Done")
          EOF

      - name: Commit and push results
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add githubmirror/26_proxy_alive.txt \
                  githubmirror/26_proxy_ru_exit.txt \
                  githubmirror/26_proxy_blocked_azure.txt

          git diff --cached --quiet || git commit -m "Proxy availability check via Xray (SOCKS + GeoIP + HTTP/HTTPS)"

          git push https://x-access-token:${GH_PAT}@github.com/${{ github.repository }} HEAD:main
