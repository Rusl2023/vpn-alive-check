name: Check VLESS proxy availability via Xray (base64 subscription)

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq unzip python3

      - name: Download Xray
        run: |
          XRAY_VER=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/download/${XRAY_VER}/Xray-linux-64.zip
          unzip -o xray.zip xray geoip.dat geosite.dat
          chmod +x xray

      - name: Prepare files (always overwrite)
        run: |
          mkdir -p githubmirror
          : > githubmirror/26_proxy_subscription_raw.txt
          : > githubmirror/26_proxy_subscription_base64.txt

      - name: Get runner IP
        run: |
          echo "RUNNER_IP=$(curl -s https://api.ipify.org)" >> $GITHUB_ENV

      - name: Check VLESS via Xray and build raw subscription
        run: |
          python3 - <<'EOF'
          import subprocess, time, json, urllib.parse, os, urllib.request

          INPUT = "githubmirror/26_ru_whitelist.txt"
          OUTPUT = "githubmirror/26_proxy_subscription_raw.txt"
          RUNNER_IP = os.environ["RUNNER_IP"]
          TEST_URLS = [
              "https://api.ipify.org",
              "http://cp.cloudflare.com",
              "https://www.instagram.com/"
          ]

          def exit_ip():
              for url in TEST_URLS:
                  try:
                      out = subprocess.check_output(
                          ["curl","-s","--max-time","8","-x","socks5h://127.0.0.1:1080",url],
                          text=True
                      ).strip()
                      if out:
                          return out
                  except:
                      pass
              return None

          def country(ip):
              try:
                  with urllib.request.urlopen(f"https://ipapi.co/{ip}/country/") as r:
                      return r.read().decode().strip()
              except:
                  return "Unknown"

          with open(INPUT) as f:
              links = [l.strip() for l in f if l.strip().startswith("vless://")]

          for link in links:
              u = urllib.parse.urlparse(link)
              q = urllib.parse.parse_qs(u.query)
              stream = {"network": q.get("type", ["tcp"])[0]}
              sec = q.get("security", ["none"])[0]
              sni = q.get("sni", [""])[0]

              if sec == "tls" and sni:
                  stream["security"] = "tls"
                  stream["tlsSettings"] = {"serverName": sni}
              if sec == "reality" and "pbk" in q:
                  stream["security"] = "reality"
                  stream["realitySettings"] = {
                      "serverName": sni,
                      "publicKey": q["pbk"][0],
                      "shortId": q.get("sid", [""])[0]
                  }

              cfg = {
                  "inbounds": [{
                      "listen": "127.0.0.1",
                      "port": 1080,
                      "protocol": "socks",
                      "settings": {"udp": False}
                  }],
                  "outbounds": [{
                      "protocol": "vless",
                      "settings": {
                          "vnext": [{
                              "address": u.hostname,
                              "port": u.port or 443,
                              "users": [{
                                  "id": u.username,
                                  "encryption": "none",
                                  "flow": q.get("flow", [""])[0]
                              }]
                          }]
                      },
                      "streamSettings": stream
                  }]
              }

              with open("cfg.json","w") as f:
                  json.dump(cfg,f)

              p = subprocess.Popen(
                  ["./xray","run","-c","cfg.json"],
                  stdout=subprocess.DEVNULL,
                  stderr=subprocess.DEVNULL
              )
              time.sleep(3)
              ip = exit_ip()
              p.terminate()
              time.sleep(1)

              if not ip or ip == RUNNER_IP:
                  continue
              if country(ip) == "RU":
                  continue

              with open(OUTPUT,"a") as f:
                  f.write(link + "\n")

          print("Raw subscription ready")
          EOF

      - name: Encode subscription to Base64
        run: |
          base64 -w 0 githubmirror/26_proxy_subscription_raw.txt > githubmirror/26_proxy_subscription_base64.txt

      - name: Commit and force-push subscription
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_proxy_subscription_raw.txt githubmirror/26_proxy_subscription_base64.txt
          git commit --allow-empty -m "Update VLESS base64 subscription (Xray verified)"
          git push -f https://x-access-token:${GH_PAT}@github.com/${GITHUB_REPOSITORY} HEAD:main
