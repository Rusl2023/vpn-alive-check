name: Check VLESS proxy availability

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq unzip python3

      - name: Download Xray (non-interactive)
        run: |
          XRAY_VER=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/download/${XRAY_VER}/Xray-linux-64.zip
          unzip -o xray.zip xray geoip.dat geosite.dat
          chmod +x xray

      - name: Prepare files
        run: |
          : > alive.txt
          : > ru_exit.txt
          : > blocked_by_azure.txt

      - name: Get runner IP
        run: |
          echo "RUNNER_IP=$(curl -s https://api.ipify.org)" >> $GITHUB_ENV

      - name: Check VLESS keys
        run: |
          python3 - <<'EOF'
          import subprocess, time, json, socket, urllib.parse, os

          RUNNER_IP = os.environ["RUNNER_IP"]

          def get_exit_ip():
              try:
                  return subprocess.check_output(
                      ["curl","-s","--max-time","8","-x","socks5h://127.0.0.1:1080","https://api.ipify.org"],
                      text=True
                  ).strip()
              except:
                  return None

          with open("26_ru_whitelist.txt") as f:
              links = [l.strip() for l in f if l.strip().startswith("vless://")]

          for link in links:
              print("Checking:", link[:80])

              u = urllib.parse.urlparse(link)
              q = urllib.parse.parse_qs(u.query)

              net = q.get("type", ["tcp"])[0]
              security = q.get("security", ["none"])[0]
              sni = q.get("sni", [""])[0]

              stream = {"network": net}

              if security == "tls" and sni:
                  stream["security"] = "tls"
                  stream["tlsSettings"] = {"serverName": sni}
              elif security == "reality" and "pbk" in q:
                  stream["security"] = "reality"
                  stream["realitySettings"] = {
                      "serverName": sni,
                      "publicKey": q.get("pbk", [""])[0],
                      "shortId": q.get("sid", [""])[0]
                  }

              outbound = {
                  "protocol": "vless",
                  "settings": {
                      "vnext": [{
                          "address": u.hostname,
                          "port": u.port,
                          "users": [{
                              "id": u.username,
                              "encryption": "none",
                              "flow": q.get("flow", [""])[0]
                          }]
                      }]
                  },
                  "streamSettings": stream
              }

              config = {
                  "inbounds": [{
                      "port": 1080,
                      "listen": "127.0.0.1",
                      "protocol": "socks",
                      "settings": {"udp": False}
                  }],
                  "outbounds": [outbound]
              }

              with open("cfg.json","w") as f:
                  json.dump(config,f)

              p = subprocess.Popen(["./xray","run","-c","cfg.json"],
                                   stdout=subprocess.DEVNULL,
                                   stderr=subprocess.DEVNULL)

              time.sleep(3)
              exit_ip = get_exit_ip()
              p.terminate()
              time.sleep(1)

              if not exit_ip or exit_ip == RUNNER_IP:
                  print("âš ï¸ Blocked / no exit")
                  with open("blocked_by_azure.txt","a") as f:
                      f.write(link+"\n")
                  continue

              country = subprocess.getoutput(f"curl -s https://ipapi.co/{exit_ip}/country/")

              if country == "RU":
                  print("ðŸ‡·ðŸ‡º RU exit")
                  with open("ru_exit.txt","a") as f:
                      f.write(link+"\n")
              else:
                  print("âœ… Alive", exit_ip)
                  with open("alive.txt","a") as f:
                      f.write(link+"\n")

          print("Done")
          EOF

      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add alive.txt ru_exit.txt blocked_by_azure.txt
          git commit -m "Check VLESS proxy availability" || true
          git push
