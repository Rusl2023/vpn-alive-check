name: Filter best VLESS per country (strict)

on:
  schedule:
    - cron: "*/9 * * * *"
  workflow_dispatch:

jobs:
  filter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false   # â— Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾

      - name: Filter best VLESS per country
        run: |
          set -e

          INPUT="githubmirror/26_alive.txt"
          OUTPUT="githubmirror/26_alive_filtered.txt"

          # ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° (Ð¡ÑƒÑ€Ð³ÑƒÑ‚, Ð¥ÐœÐÐž)
          PING_TARGET="5.141.192.1"

          if [ ! -f "$INPUT" ]; then
            echo "âŒ $INPUT not found"
            exit 0
          fi

          rm -f "$OUTPUT"

          awk '
          function get_flag(l, m) {
            if (match(l, /#.*([ðŸ‡¦-ðŸ‡¿]{2})/, m)) return m[1]
            return ""
          }

          function get_ping(l, m) {
            if (match(l, /([0-9]+)[ ]*ms/, m)) return m[1]
            return 999999
          }

          function strict_ok(l) {
            return (
              l ~ /TCP[:= ]*OK/ &&
              l ~ /HTTP[:= ]*OK/ &&
              l ~ /HTTPS[:= ]*OK/
            )
          }

          {
            if ($0 ~ /N\/A/) next

            flag = get_flag($0)
            if (flag == "") next

            ping = get_ping($0)
            if (ping >= 600) next

            if (!strict_ok($0)) next

            score = -ping

            if (!(flag in best) || score > best_score[flag]) {
              best_score[flag] = score
              best_ping[flag] = ping
              best[flag] = $0
            }
          }

          END {
            for (f in best) {
              printf "%06d|%s\n", best_ping[f], best[f]
            }
          }
          ' "$INPUT" | sort -n | cut -d'|' -f2- > "$OUTPUT"

          echo "===== FILTERED RESULT ====="
          cat "$OUTPUT"

      - name: Commit and push filtered file
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive_filtered.txt
          git diff --cached --quiet || git commit -m "Update best VLESS per country (strict)"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
