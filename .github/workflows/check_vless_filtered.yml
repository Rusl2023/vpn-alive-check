name: Check VLESS Servers by Stable Country (GeoIP)

on:
  schedule:
    - cron: '*/9 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Скачиваем репозиторий
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2️⃣ Настройка Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3️⃣ Установка зависимостей
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip requests geoip2

      # 4️⃣ Скачивание GeoLite2 базы без регистрации (публичный mirror)
      - name: Download GeoLite2 Database (public mirror)
        run: |
          mkdir -p geoip
          if [ ! -f geoip/GeoLite2-Country.mmdb ]; then
            echo "Downloading GeoLite2-Country from public mirror..."
            wget -O geoip/GeoLite2-Country.mmdb "https://github.com/P3TERX/GeoLite2-Country/raw/master/GeoLite2-Country.mmdb"
          else
            echo "GeoLite2-Country.mmdb already exists"
          fi

      # 5️⃣ Проверка VLESS серверов
      - name: Check VLESS servers (median latency ≤ 200ms + stable country)
        id: check_alive
        run: |
          python - <<'EOF'
          import os
          import time
          import socket
          import requests
          import urllib.parse
          from concurrent.futures import ThreadPoolExecutor, as_completed
          import geoip2.database

          URL = "https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt"

          TIMEOUT = 0.5      # ускорение проверки
          MAX_LATENCY = 200
          CHECK_COUNT = 3
          STABILITY_CHECKS = 3
          MAX_WORKERS = 120

          GEOIP_DB_PATH = "geoip/GeoLite2-Country.mmdb"
          reader = geoip2.database.Reader(GEOIP_DB_PATH)

          print("Downloading 26.txt ...")
          lines = requests.get(URL, timeout=20).text.splitlines()
          vless_list = [l.strip() for l in lines if l.strip().startswith("vless://")]
          print(f"Total VLESS links: {len(vless_list)}")

          def tcp_ping(host, port):
              start = time.time()
              sock = socket.create_connection((host, port), timeout=TIMEOUT)
              sock.close()
              return int((time.time() - start) * 1000)

          def median(lst):
              s = sorted(lst)
              return s[len(s)//2]

          def get_country(host):
              ip = socket.gethostbyname(host)
              response = reader.country(ip)
              return response.country.iso_code

          def parse_vless(link):
              try:
                  url = urllib.parse.urlparse(link)
                  host = url.hostname
                  port = url.port or 443
                  query = urllib.parse.parse_qs(url.query)
                  sni = query.get('sni', [host])[0]
                  security = query.get('security', [''])[0]
                  country = link.split('#')[-1] if '#' in link else 'unknown'
                  if not sni:
                      return None
                  return {
                      'link': link,
                      'host': host,
                      'port': port,
                      'sni': sni,
                      'security': security,
                      'country': country
                  }
              except Exception:
                  return None

          def is_stable_country(host, expected_country, attempts=STABILITY_CHECKS):
              try:
                  for _ in range(attempts):
                      country = get_country(host)
                      if country != expected_country:
                          return False
                  return True
              except Exception:
                  return False

          def check_vless(link):
              data = parse_vless(link)
              if not data:
                  return None
              if not is_stable_country(data['host'], data['country']):
                  return None
              try:
                  pings = []
                  for _ in range(CHECK_COUNT):
                      ping = tcp_ping(data['host'], data['port'])
                      if ping > MAX_LATENCY:
                          return None
                      pings.append(ping)
                  med_ping = median(pings)
                  if med_ping <= MAX_LATENCY:
                      return med_ping, data['link'], data['country']
              except Exception:
                  return None

          alive_by_country = {}
          start_all = time.time()

          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              futures = [exe.submit(check_vless, v) for v in vless_list]
              for i, f in enumerate(as_completed(futures), 1):
                  res = f.result()
                  if res:
                      med_ping, link, country = res
                      old = alive_by_country.get(country)
                      if not old or med_ping < old[0]:
                          alive_by_country[country] = (med_ping, link)
                          print(f"[OK] {country} {med_ping} ms")
                  if i % 50 == 0:
                      print(f"Checked {i}/{len(vless_list)}")

          results = sorted(alive_by_country.values(), key=lambda x: x[0])
          elapsed = int(time.time() - start_all)
          print(f"Finished in {elapsed} sec. Alive countries: {len(results)}")

          os.makedirs("githubmirror", exist_ok=True)
          with open("githubmirror/26_alive.txt", "w") as f:
              for med_ping, link in results:
                  f.write(link + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(results)}\n")
          EOF

      # 6️⃣ Commit и push результата
      - name: Commit and push result
        if: steps.check_alive.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive.txt
          git diff --cached --quiet || git commit -m "Update alive VLESS servers by stable country"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
