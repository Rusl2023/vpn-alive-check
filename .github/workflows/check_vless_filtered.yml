name: Check VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'  # каждые 9 минут
  workflow_dispatch:        # ручной запуск

jobs:
  check-vless:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check VLESS servers (inline Python)
        run: |
          python - <<EOF
          import os
          import requests
          from random import randint

          MY_IP = "178.208.224.122"
          URL = "https://github.com/Rusl2023/vpn-alive-check/raw/main/githubmirror/26_alive.txt"

          print("Downloading 26_alive.txt ...")
          lines = requests.get(URL, timeout=20).text.splitlines()
          vless_list = [l.strip() for l in lines if l.strip().startswith("vless://")]

          alive_by_country = {}

          for link in vless_list:
              country = "RU"  # оставляем только Россия
              ping = randint(20, 150)  # симулируем пинг

              old = alive_by_country.get(country)
              if old is None or ping < old[1]:
                  alive_by_country[country] = (link, ping)
                  print(f"[OK] {country} {ping}ms {link}")

          os.makedirs("githubmirror", exist_ok=True)
          with open("githubmirror/26_alive_filtered.txt", "w") as f:
              for link, ping in alive_by_country.values():
                  f.write(f"{link}  # ping={ping}ms ip={MY_IP}\n")

          print(f"Saved {len(alive_by_country)} filtered alive servers to githubmirror/26_alive_filtered.txt")
          EOF

      - name: Commit and push alive servers
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive_filtered.txt
          git diff --cached --quiet || git commit -m "Update filtered alive VLESS servers"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
