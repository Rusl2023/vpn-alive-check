import socket, time, os, ssl, re

INPUT = "githubmirror/26_alive.txt"
OUTPUT = "githubmirror/26_alive_filtered.txt"

TIMEOUT = 1.5
MAX_PING = 600

# строгий флаг страны (эмодзи)
FLAG_RE = re.compile(r"#.*?([\U0001F1E6-\U0001F1FF]{2})")

def tcp_ping(host, port):
    start = time.time()
    s = socket.create_connection((host, port), timeout=TIMEOUT)
    s.close()
    return int((time.time() - start) * 1000)

def tls_check(host, port):
    ctx = ssl._create_unverified_context()
    s = socket.create_connection((host, port), timeout=TIMEOUT)
    s = ctx.wrap_socket(s, server_hostname=host)
    s.close()

best = {}

with open(INPUT, encoding="utf-8", errors="ignore") as f:
    for line in f:
        line = line.strip()

        if not line.startswith("vless://"):
            continue

        # ❌ жёстко режем мусор
        if "Unknown" in line or "Cloudflare" in line:
            continue

        m = FLAG_RE.search(line)
        if not m:
            continue  # ❌ нет флага — в мусор

        country = m.group(1)

        try:
            netloc = line.split("@", 1)[1].split("?", 1)[0]
            host, port = netloc.split(":")
            port = int(port)
        except:
            continue

        try:
            ping = tcp_ping(host, port)
            if ping > MAX_PING:
                continue
            tls_check(host, port)
        except:
            continue

        if country not in best or ping < best[country][0]:
            best[country] = (ping, line)

os.makedirs("githubmirror", exist_ok=True)

with open(OUTPUT, "w", encoding="utf-8") as f:
    for ping, line in sorted(best.values(), key=lambda x: x[0]):
        f.write(line + "\n")

print("===== FINAL FILTERED RESULT =====")
print(open(OUTPUT, encoding="utf-8").read())
