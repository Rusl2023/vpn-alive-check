name: Filter best VLESS per country (strict)

on:
  schedule:
    - cron: "*/9 * * * *"
  workflow_dispatch:

jobs:
  filter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Filter best VLESS per country
        run: |
          INPUT="githubmirror/26_alive.txt"
          OUTPUT="githubmirror/26_alive_filtered.txt"

          if [ ! -f "$INPUT" ]; then
            echo "âŒ $INPUT not found"
            exit 0
          fi

          awk '
          function get_flag(l) {
            if (match(l, /#.*([ðŸ‡¦-ðŸ‡¿]{2})/, m)) return m[1]
            return ""
          }

          function get_ping(l) {
            if (match(l, /([0-9]+)[ ]*ms/, m)) return m[1]
            return 999999
          }

          {
            if ($0 ~ /N\/A/) next
            if ($0 !~ /TCP[:= ]*OK/) next
            if ($0 !~ /HTTP[:= ]*OK/) next
            if ($0 !~ /HTTPS[:= ]*OK/) next

            flag = get_flag($0)
            if (flag == "") next

            ping = get_ping($0)
            if (ping >= 600) next

            if (!(flag in best) || ping < best_ping[flag]) {
              best[flag] = $0
              best_ping[flag] = ping
            }
          }

          END {
            for (f in best) {
              printf "%06d|%s\n", best_ping[f], best[f]
            }
          }
          ' "$INPUT" | sort -n | cut -d"|" -f2- > "$OUTPUT"

          echo "===== FILTERED RESULT ====="
          cat "$OUTPUT"

      - name: Commit and push filtered file
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive_filtered.txt
          git diff --cached --quiet || git commit -m "Update best VLESS per country (strict)"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
