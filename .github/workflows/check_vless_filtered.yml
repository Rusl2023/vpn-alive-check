name: Filter best VLESS per country (strict)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  filter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Filter best VLESS per country
        run: |
          set -e

          INPUT="26_alive.txt"
          OUTPUT="26_alive_filtered.txt"

          # ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° â€” Ð¡ÑƒÑ€Ð³ÑƒÑ‚, Ð¥ÐœÐÐž
          PING_TARGET="5.141.192.1"

          rm -f "$OUTPUT"

          awk -v PING_TARGET="$PING_TARGET" '
          function extract_flag(l, m) {
            if (match(l, /#[^ðŸ‡¦-ðŸ‡¿]*([ðŸ‡¦-ðŸ‡¿]{2})/, m)) return m[1]
            return ""
          }

          function extract_ping(l, m) {
            if (match(l, /ping[=: ]*([0-9]+)/, m)) return m[1]
            return 999999
          }

          function extract_stability(l, m) {
            if (match(l, /stability[=: ]*([0-9]+)/, m)) return m[1]
            return 0
          }

          function strict_ok(l) {
            return (
              l ~ /TCP[:= ]*OK/ &&
              l ~ /HTTP[:= ]*OK/ &&
              l ~ /HTTPS[:= ]*OK/
            )
          }

          {
            flag = extract_flag($0)
            if (flag == "") next

            ping = extract_ping($0)
            stab = extract_stability($0)

            if (ping >= 600) next
            if (!strict_ok($0)) next

            key = flag

            # Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð° Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð°:
            # ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð²Ð°Ð¶Ð½ÐµÐµ, Ð¿Ð¾Ñ‚Ð¾Ð¼ ping
            score = (stab * 1000000) - ping

            if (!(key in best_score) || score > best_score[key]) {
              best_score[key] = score
              best_line[key] = $0
              best_ping[key] = ping
            }
          }

          END {
            for (k in best_line) {
              printf "%06d|%s\n", best_ping[k], best_line[k]
            }
          }
          ' "$INPUT" | sort -n | cut -d'|' -f2- > "$OUTPUT"

          echo "===== RESULT ====="
          cat "$OUTPUT"

      - name: Commit filtered file
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add 26_alive_filtered.txt
          git commit -m "Update best VLESS per country (strict, no N/A)" || echo "No changes"
          git push
