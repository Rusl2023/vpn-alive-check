name: Build VLESS Russian SNI Whitelist

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build RU SNI whitelist
        id: build_list
        run: |
          python - <<'EOF'
          import requests
          import urllib.parse
          import os

          URL = "https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt"

          RU_SNI_WHITELIST = {
              "stats.vk-portal.net",
              "sun6-21.userapi.com",
              "sun6-20.userapi.com",
              "avatars.mds.yandex.net",
              "queuev4.vk.com",
              "sun6-22.userapi.com",
              "sync.browser.yandex.net",
              "top-fwz1.mail.ru",
              "ad.mail.ru",
              "eh.vk.com",
              "akashi.vk-portal.net",
              "sun9-38.userapi.com",
              "st.ozone.ru",
              "ir.ozone.ru",
              "vt-1.ozone.ru",
              "io.ozone.ru",
              "ozone.ru",
              "xapi.ozon.ru",
              "strm-rad-23.strm.yandex.net",
              "online.sberbank.ru",
              "esa-res.online.sberbank.ru",
              "egress.yandex.net",
              "st.okcdn.ru",
              "rs.mail.ru",
              "counter.yadro.ru",
              "splitter.wb.ru",
              "a.wb.ru",
              "user-geo-data.wildberries.ru",
              "banners-website.wildberries.ru",
              "chat-prod.wildberries.ru",
              "servicepipe.ru",
              "alfabank.ru",
              "alfabank.servicecdn.ru",
              "alfabank.st",
              "privacy-cs.mail.ru",
              "imgproxy.cdn-tinkoff.ru",
              "mddc.tinkoff.ru",
              "le.tbank.ru",
              "hrc.tbank.ru",
              "id.tbank.ru",
              "nspk.ru",
              "login.vk.com",
              "mtscdn.ru",
              "storage.yandexcloud.net",
              "www.tbank.ru",
              "vk.com",
              "www.wildberries.ru",
              "www.ozon.ru",
              "ok.ru",
              "yandex.ru",
              "www.unicreditbank.ru",
              "www.gazprombank.ru",
              "cdn.gpb.ru",
              "mkb.ru",
              "www.open.ru",
              "cdn.rosbank.ru",
              "www.psbank.ru",
              "www.raiffeisen.ru",
              "www.rzd.ru",
              "www.pochta.ru",
              "passport.pochta.ru",
              "www.x5.ru",
              "www.ivi.ru",
              "hh.ru",
              "www.kp.ru",
              "lenta.ru",
              "www.rbc.ru",
              "pikabu.ru",
              "www.tutu.ru",
              "www.drom.ru",
              "www.drive2.ru",
              "lemanapro.ru"
          }

          print("Downloading 26.txt ...")
          lines = requests.get(URL, timeout=30).text.splitlines()

          result = []
          seen = set()

          for line in lines:
              if not line.startswith("vless://"):
                  continue
              try:
                  u = urllib.parse.urlparse(line)
                  q = urllib.parse.parse_qs(u.query)
                  sni = q.get("sni", [""])[0].lower()
                  if sni in RU_SNI_WHITELIST and line not in seen:
                      result.append(line)
                      seen.add(line)
              except Exception:
                  continue

          print(f"Found {len(result)} VLESS links with RU SNI whitelist")

          os.makedirs("githubmirror", exist_ok=True)
          with open("githubmirror/26_ru_whitelist.txt", "w") as f:
              for v in result:
                  f.write(v + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(result)}\n")
          EOF

      - name: Commit and push result
        if: steps.build_list.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_ru_whitelist.txt
          git diff --cached --quiet || git commit -m "Update VLESS Russian SNI whitelist"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
