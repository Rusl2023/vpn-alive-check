name: Check VLESS RU Whitelist + GeoIP

on:
  schedule:
    - cron: '*/9 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests geoip2

      - name: Check VLESS servers (RU SNI + GeoIP)
        id: check_alive
        run: |
          python - <<'EOF'
          import os, time, socket, requests, urllib.parse
          from concurrent.futures import ThreadPoolExecutor, as_completed
          import geoip2.database

          URL = "https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt"

          TIMEOUT = 0.6
          MAX_LATENCY = 600
          CHECK_COUNT = 3
          TCP_PASSES = 2
          MAX_WORKERS = 120

          ALLOWED_COUNTRIES = {"PL", "FI", "NL", "LV"}

          GEOIP_DB = "geoip/GeoLite2-Country.mmdb"
          reader = geoip2.database.Reader(GEOIP_DB)

          RU_SNI_WHITELIST = {
              "vk.com","ok.ru","yandex.ru","ozone.ru","www.ozon.ru",
              "st.ozone.ru","ir.ozone.ru","api.mts.ru","login.vk.com",
              "online.sberbank.ru","alfabank.ru","www.wildberries.ru",
              "cdn.gpb.ru","www.raiffeisen.ru","www.tinkoff.ru"
          }

          print("Downloading 26.txt ...")
          lines = requests.get(URL, timeout=20).text.splitlines()
          vless_links = [l for l in lines if l.startswith("vless://")]
          print("Total VLESS:", len(vless_links))

          def tcp_ping(host, port):
              start = time.time()
              s = socket.create_connection((host, port), timeout=TIMEOUT)
              s.close()
              return int((time.time() - start) * 1000)

          def median(lst):
              lst = sorted(lst)
              return lst[len(lst)//2]

          def geo_country(host):
              ip = socket.gethostbyname(host)
              return reader.country(ip).country.iso_code

          def parse_vless(link):
              try:
                  u = urllib.parse.urlparse(link)
                  q = urllib.parse.parse_qs(u.query)
                  return {
                      "link": link,
                      "host": u.hostname,
                      "port": u.port or 443,
                      "security": q.get("security", [""])[0],
                      "sni": q.get("sni", [""])[0]
                  }
              except:
                  return None

          def check_vless(link):
              d = parse_vless(link)
              if not d:
                  return None

              if d["security"] != "reality":
                  return None

              if not d["sni"] or d["sni"] not in RU_SNI_WHITELIST:
                  return None

              try:
                  country = geo_country(d["host"])
                  if country not in ALLOWED_COUNTRIES:
                      return None
              except:
                  return None

              try:
                  for _ in range(TCP_PASSES):
                      socket.create_connection((d["host"], d["port"]), timeout=TIMEOUT).close()

                  pings = []
                  for _ in range(CHECK_COUNT):
                      p = tcp_ping(d["host"], d["port"])
                      if p > MAX_LATENCY:
                          return None
                      pings.append(p)

                  return country, median(pings), d["link"]
              except:
                  return None

          best_by_country = {}

          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              futures = [exe.submit(check_vless, v) for v in vless_links]
              for f in as_completed(futures):
                  r = f.result()
                  if not r:
                      continue
                  country, ping, link = r
                  old = best_by_country.get(country)
                  if not old or ping < old[0]:
                      best_by_country[country] = (ping, link)
                      print(f"[OK] {country} {ping} ms")

          results = sorted(best_by_country.values(), key=lambda x: x[0])

          os.makedirs("githubmirror", exist_ok=True)
          with open("githubmirror/26_ru_whitelist.txt", "w") as f:
              for _, link in results:
                  f.write(link + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(results)}\n")

          print("Final countries:", len(results))
          EOF

      - name: Commit and push result
        if: steps.check_alive.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_ru_whitelist.txt
          git diff --cached --quiet || git commit -m "Update RU whitelist VLESS (GeoIP filtered)"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
