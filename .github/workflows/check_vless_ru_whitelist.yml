name: Check VLESS RU Whitelist + Reality Vision + GeoIP + HTTPS + Speed

on:
  schedule:
    - cron: '*/9 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests geoip2

      - name: Download Xray
        run: |
          XRAY_VER=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/download/${XRAY_VER}/Xray-linux-64.zip
          unzip -o xray.zip xray
          chmod +x xray

      - name: Download GeoIP DB
        run: |
          mkdir -p geoip
          curl -L -o geoip/GeoLite2-Country.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb
          curl -L -o geoip/GeoLite2-ASN.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-ASN.mmdb

      - name: Check VLESS servers (FULL Reality + Cloudflare HTTPS + Speed)
        run: |
          python - <<'EOF'
          import os, time, socket, urllib.parse, requests, re, subprocess, json, threading
          from concurrent.futures import ThreadPoolExecutor, as_completed
          import geoip2.database

          URL = "https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt"
          MIN_SPEED = 50_000
          MAX_WORKERS = 30
          PORT_BASE = 10800

          reader_country = geoip2.database.Reader("geoip/GeoLite2-Country.mmdb")

          RU_SNI_WHITELIST = {
              "stats.vk-portal.net","sun6-21.userapi.com","sun6-20.userapi.com",
              "avatars.mds.yandex.net","queuev4.vk.com","sun6-22.userapi.com",
              "sync.browser.yandex.net","top-fwz1.mail.ru","ad.mail.ru","eh.vk.com",
              "akashi.vk-portal.net","sun9-38.userapi.com","st.ozone.ru",
              "ir.ozone.ru","vt-1.ozone.ru","io.ozone.ru","ozone.ru","xapi.ozon.ru",
              "strm-rad-23.strm.yandex.net","online.sberbank.ru","esa-res.online.sberbank.ru",
              "egress.yandex.net","st.okcdn.ru","rs.mail.ru","counter.yadro.ru",
              "742231.ms.ok.ru","splitter.wb.ru","a.wb.ru","user-geo-data.wildberries.ru",
              "banners-website.wildberries.ru","chat-prod.wildberries.ru","servicepipe.ru",
              "alfabank.ru","statad.ru","alfabank.servicecdn.ru","alfabank.st",
              "ad.adriver.ru","privacy-cs.mail.ru","imgproxy.cdn-tinkoff.ru",
              "mddc.tinkoff.ru","le.tbank.ru","hrc.tbank.ru","id.tbank.ru",
              "rap.skcrtxr.com","eye.targetads.io","px.adhigh.net","nspk.ru",
              "sba.yandex.net","identitystatic.mts.ru","tag.a.mts.ru","login.mts.ru",
              "serving.a.mts.ru","cm.a.mts.ru","login.vk.com","api.a.mts.ru",
              "mtscdn.ru","d5de4k0ri8jba7ucdbt6.apigw.yandexcloud.net","moscow.megafon.ru",
              "api.mindbox.ru","web-static.mindbox.ru","storage.yandexcloud.net",
              "personalization-web-stable.mindbox.ru","www.t2.ru","beeline.api.flocktory.com",
              "static.beeline.ru","moskva.beeline.ru","wcm.weborama-tech.ru",
              "1013a--ma--8935--cp199.stbid.ru","msk.t2.ru","s3.t2.ru","get4click.ru",
              "dzen.ru","yastatic.net","csp.yandex.net","sntr.avito.ru",
              "yabro-wbplugin.edadeal.yandex.ru","cdn.uxfeedback.ru","goya.rutube.ru",
              "api.expf.ru","fb-cdn.premier.one","www.kinopoisk.ru","widgets.kinopoisk.ru",
              "payment-widget.plus.kinopoisk.ru","api.events.plus.yandex.net",
              "tns-counter.ru","speller.yandex.net","widgets.cbonds.ru","www.magnit.com",
              "magnit-ru.injector.3ebra.net","jsons.injector.3ebra.net","2gis.ru",
              "d-assets.2gis.ru","s1.bss.2gis.com","www.tbank.ru",
              "vk.com","www.wildberries.ru","www.ozon.ru","ok.ru","yandex.ru"
          }

          UUID_RE = re.compile(r"^[0-9a-fA-F\-]{36}$")
          port_lock = threading.Lock()
          port_counter = 0

          def alloc_port():
              global port_counter
              with port_lock:
                  p = PORT_BASE + port_counter
                  port_counter += 1
                  return p

          def https_ok(port):
              try:
                  out = subprocess.check_output(
                      ["curl","-s","--max-time","5",
                       "-x",f"socks5h://127.0.0.1:{port}",
                       "https://cloudflare.com/cdn-cgi/trace"],
                      text=True
                  )
                  return "ip=" in out
              except:
                  return False

          def speed_ok(port):
              try:
                  r = subprocess.check_output(
                      ["curl","-s","-L","-o","/dev/null","-w","%{speed_download}",
                       "-x",f"socks5h://127.0.0.1:{port}",
                       "--range","0-200000","--max-time","5",
                       "https://speed.cloudflare.com/__down"],
                      text=True
                  )
                  return int(float(r)) >= MIN_SPEED
              except:
                  return False

          def check(link):
              port = alloc_port()
              p = None
              try:
                  u = urllib.parse.urlparse(link)
                  q = urllib.parse.parse_qs(u.query)

                  if q.get("security",[""])[0] != "reality":
                      return None
                  if q.get("flow",[""])[0] != "xtls-rprx-vision":
                      return None

                  sni = q.get("sni",[""])[0]
                  pbk = q.get("pbk",[""])[0]
                  sid = q.get("sid",[""])[0]
                  fp  = q.get("fp",["chrome"])[0]

                  if not sni or sni not in RU_SNI_WHITELIST:
                      return None
                  if not pbk or not UUID_RE.match(u.username):
                      return None

                  try:
                      ip = socket.gethostbyname(u.hostname)
                  except socket.gaierror:
                      return None

                  if reader_country.country(ip).country.iso_code == "RU":
                      return None

                  cfg = {
                      "inbounds":[{"port":port,"listen":"127.0.0.1","protocol":"socks"}],
                      "outbounds":[{
                          "protocol":"vless",
                          "settings":{"vnext":[{
                              "address":u.hostname,
                              "port":u.port or 443,
                              "users":[{"id":u.username,"encryption":"none","flow":"xtls-rprx-vision"}]
                          }]},
                          "streamSettings":{
                              "security":"reality",
                              "realitySettings":{
                                  "serverName":sni,
                                  "publicKey":pbk,
                                  "shortId":sid,
                                  "fingerprint":fp
                              }
                          }
                      }]
                  }

                  cfg_path = f"cfg_{port}.json"
                  open(cfg_path,"w").write(json.dumps(cfg))
                  p = subprocess.Popen(["./xray","run","-c",cfg_path],
                                        stdout=subprocess.DEVNULL,stderr=subprocess.DEVNULL)
                  time.sleep(4)

                  ok = https_ok(port) and speed_ok(port)
                  return link if ok else None
              finally:
                  if p:
                      p.terminate()
                      time.sleep(0.5)

          links = [l for l in requests.get(URL,timeout=20).text.splitlines()
                   if l.startswith("vless://")]

          alive = []
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as ex:
              for f in as_completed([ex.submit(check,l) for l in links]):
                  r = f.result()
                  if r:
                      alive.append(r)
                      print("[OK]")

          os.makedirs("githubmirror",exist_ok=True)
          with open("githubmirror/26_ru_whitelist.txt","w") as f:
              for l in alive:
                  f.write(l+"\n")

          print("FINAL:",len(alive))
          EOF

      - name: Commit and push (always overwrite)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_ru_whitelist.txt
          git commit -m "Update RU whitelist (Reality + Cloudflare HTTPS + Speed)" || true
          git push -f https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
