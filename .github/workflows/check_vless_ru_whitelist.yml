name: Check VLESS RU Whitelist + Reality Vision + GeoIP + ASN

on:
  schedule:
    - cron: '*/9 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests geoip2

      - name: Check VLESS servers (Reality Vision + SNI + GeoIP + ASN)
        id: check_alive
        run: |
          python - <<'EOF'
          import os, time, socket, urllib.parse, requests
          from concurrent.futures import ThreadPoolExecutor, as_completed
          import geoip2.database

          URLS = [
           "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/all_sub.txt",
           "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/26.txt",
           "https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/vless_configs.txt",
           "https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/WHITE-SNI-RU-all.txt",
           "https://raw.githubusercontent.com/hamedcode/port-based-v2ray-configs/main/sub/vless.txt"
          ]

          TIMEOUT = 0.6
          CHECK_COUNT = 20
          MAX_LATENCY = 600
          MAX_WORKERS = 120

          COUNTRY_DB = "geoip/GeoLite2-Country.mmdb"
          ASN_DB = "geoip/GeoLite2-ASN.mmdb"

          reader_country = geoip2.database.Reader(COUNTRY_DB)
          reader_asn = geoip2.database.Reader(ASN_DB)

          RU_SNI_WHITELIST = {
              "stats.vk-portal.net","sun6-21.userapi.com","sun6-20.userapi.com",
              "avatars.mds.yandex.net","queuev4.vk.com","sun6-22.userapi.com",
              "sync.browser.yandex.net","top-fwz1.mail.ru","ad.mail.ru","eh.vk.com",
              "akashi.vk-portal.net","sun9-38.userapi.com","st.ozone.ru",
              "ir.ozone.ru","vt-1.ozone.ru","io.ozone.ru","ozone.ru","xapi.ozon.ru",
              "strm-rad-23.strm.yandex.net","online.sberbank.ru","esa-res.online.sberbank.ru",
              "egress.yandex.net","st.okcdn.ru","rs.mail.ru","counter.yadro.ru",
              "742231.ms.ok.ru","splitter.wb.ru","a.wb.ru","user-geo-data.wildberries.ru",
              "banners-website.wildberries.ru","chat-prod.wildberries.ru","servicepipe.ru",
              "alfabank.ru","statad.ru","alfabank.servicecdn.ru","alfabank.st",
              "ad.adriver.ru","privacy-cs.mail.ru","imgproxy.cdn-tinkoff.ru",
              "mddc.tinkoff.ru","le.tbank.ru","hrc.tbank.ru","id.tbank.ru","rap.skcrtxr.com",
              "eye.targetads.io","px.adhigh.net","nspk.ru","sba.yandex.net",
              "identitystatic.mts.ru","tag.a.mts.ru","login.mts.ru","serving.a.mts.ru",
              "cm.a.mts.ru","login.vk.com","api.a.mts.ru","mtscdn.ru",
              "d5de4k0ri8jba7ucdbt6.apigw.yandexcloud.net","moscow.megafon.ru",
              "api.mindbox.ru","web-static.mindbox.ru","storage.yandexcloud.net",
              "personalization-web-stable.mindbox.ru","www.t2.ru","beeline.api.flocktory.com",
              "static.beeline.ru","moskva.beeline.ru","wcm.weborama-tech.ru",
              "1013a--ma--8935--cp199.stbid.ru","msk.t2.ru","s3.t2.ru","get4click.ru",
              "dzen.ru","yastatic.net","csp.yandex.net","sntr.avito.ru",
              "yabro-wbplugin.edadeal.yandex.ru","cdn.uxfeedback.ru","goya.rutube.ru",
              "api.expf.ru","fb-cdn.premier.one","www.kinopoisk.ru",
              "widgets.kinopoisk.ru","payment-widget.plus.kinopoisk.ru",
              "api.events.plus.yandex.net","tns-counter.ru","speller.yandex.net",
              "widgets.cbonds.ru","www.magnit.com","vk.com","www.wildberries.ru",
              "www.ozon.ru","ok.ru","yandex.ru","www.unicreditbank.ru",
              "www.gazprombank.ru","cdn.gpb.ru","mkb.ru","www.open.ru",
              "cobrowsing.tbank.ru","cdn.rosbank.ru","www.psbank.ru",
              "www.raiffeisen.ru","www.rzd.ru"
          }

          def is_valid_flow(link):
              u = urllib.parse.urlparse(link)
              q = urllib.parse.parse_qs(u.query)
              flow = q.get("flow", [""])[0]
              return flow == "xtls-rprx-vision" and "xhttp" not in flow

          def geo_country(host):
              try:
                  ip = socket.gethostbyname(host)
                  country = reader_country.country(ip).country.iso_code
                  return None if country == "RU" else country
              except:
                  return None

          def tcp_ping(host, port):
              t = time.time()
              s = socket.create_connection((host, port), timeout=TIMEOUT)
              s.close()
              return int((time.time() - t) * 1000)

          def median(lst):
              lst = sorted(lst)
              return lst[len(lst)//2]

          def parse_vless(link):
              u = urllib.parse.urlparse(link)
              q = urllib.parse.parse_qs(u.query)
              return {
                  "link": link,
                  "host": u.hostname,
                  "port": u.port or 443,
                  "security": q.get("security", [""])[0],
                  "sni": q.get("sni", [""])[0],
                  "flow": q.get("flow", [""])[0]
              }

          def check_vless(link):
              d = parse_vless(link)
              if not d or d["security"] != "reality":
                  return None
              if not d["sni"] or d["sni"] not in RU_SNI_WHITELIST:
                  return None
              if not is_valid_flow(d["link"]):
                  return None
              if not geo_country(d["host"]):
                  return None
              try:
                  pings = []
                  for _ in range(CHECK_COUNT):
                      p = tcp_ping(d["host"], d["port"])
                      if p > MAX_LATENCY:
                          return None
                      pings.append(p)
                  return median(pings), d["link"]
              except:
                  return None

          lines = []
          for url in URLS:
              lines.extend(requests.get(url, timeout=20).text.splitlines())

          vless_links = [l for l in lines if l.startswith("vless://")]

          results = []
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              for f in as_completed([exe.submit(check_vless, v) for v in vless_links]):
                  r = f.result()
                  if r:
                      results.append(r)

          results.sort(key=lambda x: x[0])
          os.makedirs("githubmirror", exist_ok=True)
          with open("githubmirror/26_ru_whitelist.txt", "w") as f:
              for _, link in results:
                  f.write(link + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(results)}\n")
          EOF

      - name: Commit and push result
        if: steps.check_alive.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_ru_whitelist.txt
          git diff --cached --quiet || git commit -m "Update RU whitelist VLESS (GeoIP only, no Russia IPs)"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
