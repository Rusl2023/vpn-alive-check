name: Check VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'  # каждые 9 минут
  workflow_dispatch:        # ручной запуск

jobs:
  check-vless:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check VLESS servers
        id: check_alive
        run: |
          import os, requests, socket, time

          # Скачиваем список серверов
          url = 'https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt'
          resp = requests.get(url)
          lines = resp.text.strip().splitlines()

          alive_by_country = {}  # словарь {страна: (vless, ping_ms)}

          for line in lines:
              line = line.strip()
              if not line.startswith('vless://'):
                  continue

              # Получаем страну из #<country> в конце
              if '#' in line:
                  country = line.split('#')[-1].strip()
              else:
                  country = 'unknown'

              # Парсим хост и порт (vless://uuid@host:port)
              try:
                  host_port = line.split('@')[1].split('?')[0]
                  host, port = host_port.split(':')
                  port = int(port)
              except Exception:
                  continue

              # Измеряем простой TCP-пинг
              start = time.time()
              try:
                  sock = socket.create_connection((host, port), timeout=3)
                  sock.close()
                  ping = int((time.time() - start) * 1000)  # мс
              except Exception:
                  continue

              # Выбираем сервер с минимальным ping для страны
              if country not in alive_by_country or ping < alive_by_country[country][1]:
                  alive_by_country[country] = (line, ping)

          # Записываем живые сервера в файл
          output_file = 'githubmirror/26_alive.txt'
          os.makedirs(os.path.dirname(output_file), exist_ok=True)
          with open(output_file, 'w') as f:
              for vless, _ in alive_by_country.values():
                  f.write(vless + '\n')

          print(f"::set-output name=count::{len(alive_by_country)}")

      - name: Commit and push alive servers
        if: steps.check_alive.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive.txt
          git diff --cached --quiet || git commit -m "Update alive VLESS servers"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
