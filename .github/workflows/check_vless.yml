name: Check VLESS Servers

on:
  schedule:
    - cron: '*/9 * * * *'
  workflow_dispatch:

jobs:
  check-vless:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false   # ⚠️ обязательно для пуша через GH_PAT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests websocket-client

      - name: Check VLESS servers (parallel, WS check)
        id: check_alive
        run: |
          python - <<'EOF'
          import os, requests, socket, time
          from concurrent.futures import ThreadPoolExecutor, as_completed
          import websocket

          URL = 'https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt'
          TCP_TIMEOUT = 1.0
          WS_TIMEOUT = 1.0
          MAX_WORKERS = 120

          print("Downloading 26.txt ...")
          lines = requests.get(URL, timeout=20).text.splitlines()
          vless_list = [l.strip() for l in lines if l.strip().startswith("vless://")]
          print(f"Total VLESS links: {len(vless_list)}")

          def check_vless_ws(link):
              try:
                  country = link.split('#')[-1] if '#' in link else 'unknown'
                  hp = link.split('@')[1].split('?')[0]
                  host, port = hp.split(':')
                  port = int(port)

                  # TCP check
                  start = time.time()
                  sock = socket.create_connection((host, port), timeout=TCP_TIMEOUT)
                  sock.close()
                  tcp_ping = int((time.time() - start) * 1000)

                  # Minimal WebSocket check
                  ws_url = f"ws://{host}:{port}/"
                  try:
                      ws_start = time.time()
                      ws = websocket.create_connection(ws_url, timeout=WS_TIMEOUT)
                      ws.close()
                      ws_ping = int((time.time() - ws_start) * 1000)
                  except:
                      return None  # n/a, сервер не отвечает по WS

                  # Используем TCP ping для сортировки
                  return country, link, tcp_ping
              except:
                  return None

          alive_by_country = {}

          start_all = time.time()
          with ThreadPoolExecutor(max_workers=MAX_WORKERS) as exe:
              futures = [exe.submit(check_vless_ws, v) for v in vless_list]

              for i, f in enumerate(as_completed(futures), 1):
                  res = f.result()
                  if not res:
                      continue  # пропускаем n/a
                  country, link, ping = res
                  old = alive_by_country.get(country)
                  if old is None or ping < old[1]:
                      alive_by_country[country] = (link, ping)
                      print(f"[OK] {country} {ping} ms")

                  if i % 50 == 0:
                      print(f"Checked {i}/{len(vless_list)}")

          elapsed = int(time.time() - start_all)
          print(f"DONE in {elapsed}s. Countries: {len(alive_by_country)}")

          os.makedirs("githubmirror", exist_ok=True)
          with open("githubmirror/26_alive.txt", "w") as f:
              for link, _ in alive_by_country.values():
                  f.write(link + "\n")

          # Output count
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"count={len(alive_by_country)}\n")
          EOF

      - name: Commit and push alive servers
        if: steps.check_alive.outputs.count != '0'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive.txt
          git diff --cached --quiet || git commit -m "Update alive VLESS servers"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
